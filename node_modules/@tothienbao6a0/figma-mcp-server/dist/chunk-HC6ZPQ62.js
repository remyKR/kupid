import{StdioServerTransport as Bt}from"@modelcontextprotocol/sdk/server/stdio.js";import{config as Ht}from"dotenv";import{resolve as Gt}from"path";import{config as Fe}from"dotenv";import Ie from"yargs";import{hideBin as Ae}from"yargs/helpers";Fe();function Ne(e){return e.length<=4?"****":`****${e.slice(-4)}`}function Q(e){let n=Ie(Ae(process.argv)).options({"figma-api-key":{type:"string",description:"Figma API key"},port:{type:"number",description:"Port to run the server on"}}).help().version("0.2.1").parseSync(),t={figmaApiKey:"",port:3333,configSources:{figmaApiKey:"env",port:"default"}};return n["figma-api-key"]?(t.figmaApiKey=n["figma-api-key"],t.configSources.figmaApiKey="cli"):process.env.FIGMA_API_KEY&&(t.figmaApiKey=process.env.FIGMA_API_KEY,t.configSources.figmaApiKey="env"),n.port?(t.port=n.port,t.configSources.port="cli"):process.env.PORT&&(t.port=parseInt(process.env.PORT,10),t.configSources.port="env"),t.figmaApiKey||(console.error("FIGMA_API_KEY is required (via CLI argument --figma-api-key or .env file)"),process.exit(1)),e||(console.log(`
Configuration:`),console.log(`- FIGMA_API_KEY: ${Ne(t.figmaApiKey)} (source: ${t.configSources.figmaApiKey})`),console.log(`- PORT: ${t.port} (source: ${t.configSources.port})`),console.log()),t}import{randomUUID as De}from"crypto";import ee from"express";import{SSEServerTransport as Oe}from"@modelcontextprotocol/sdk/server/sse.js";import{StreamableHTTPServerTransport as Pe}from"@modelcontextprotocol/sdk/server/streamableHttp.js";import{isInitializeRequest as je}from"@modelcontextprotocol/sdk/types.js";import"@modelcontextprotocol/sdk/server/mcp.js";var d={isHTTP:!1,log:(...e)=>{d.isHTTP?console.log("[INFO]",...e):console.error("[INFO]",...e)},error:(...e)=>{console.error("[ERROR]",...e)}};var Ve=null,w={streamable:{},sse:{}};async function ne(e,n){let t=ee();t.use("/mcp",ee.json()),t.post("/mcp",async(i,s)=>{d.log("Received StreamableHTTP request");let r=i.headers["mcp-session-id"],a;if(r&&w.streamable[r])d.log("Reusing existing StreamableHTTP transport for sessionId",r),a=w.streamable[r];else if(!r&&je(i.body))d.log("New initialization request for StreamableHTTP sessionId",r),a=new Pe({sessionIdGenerator:()=>De(),onsessioninitialized:p=>{w.streamable[p]=a}}),a.onclose=()=>{a.sessionId&&delete w.streamable[a.sessionId]},await n.connect(a);else{d.log("Invalid request:",i.body),s.status(400).json({jsonrpc:"2.0",error:{code:-32e3,message:"Bad Request: No valid session ID provided"},id:null});return}let l=null,g=i.body.params?._meta?.progressToken,c=0;g&&(d.log(`Setting up progress notifications for token ${g} on session ${r}`),l=setInterval(async()=>{d.log("Sending progress notification",c),await n.server.notification({method:"notifications/progress",params:{progress:c,progressToken:g}}),c++},1e3)),d.log("Handling StreamableHTTP request"),await a.handleRequest(i,s,i.body),l&&clearInterval(l),d.log("StreamableHTTP request handled")});let o=async(i,s)=>{let r=i.headers["mcp-session-id"];if(!r||!w.streamable[r]){s.status(400).send("Invalid or missing session ID");return}console.log(`Received session termination request for session ${r}`);try{await w.streamable[r].handleRequest(i,s)}catch(a){console.error("Error handling session termination:",a),s.headersSent||s.status(500).send("Error processing session termination")}};t.get("/mcp",o),t.delete("/mcp",o),t.get("/sse",async(i,s)=>{d.log("Establishing new SSE connection");let r=new Oe("/messages",s);d.log(`New SSE connection established for sessionId ${r.sessionId}`),d.log("/sse request headers:",i.headers),d.log("/sse request body:",i.body),w.sse[r.sessionId]=r,s.on("close",()=>{delete w.sse[r.sessionId]}),await n.connect(r)}),t.post("/messages",async(i,s)=>{let r=i.query.sessionId,a=w.sse[r];if(a)d.log(`Received SSE message for sessionId ${r}`),d.log("/messages request headers:",i.headers),d.log("/messages request body:",i.body),await a.handlePostMessage(i,s);else{s.status(400).send(`No transport found for sessionId ${r}`);return}}),Ve=t.listen(e,()=>{d.log(`HTTP server listening on port ${e}`),d.log(`SSE endpoint available at http://localhost:${e}/sse`),d.log(`Message endpoint available at http://localhost:${e}/messages`),d.log(`StreamableHTTP endpoint available at http://localhost:${e}/mcp`)}),process.on("SIGINT",async()=>{d.log("Shutting down server..."),await te(w.sse),await te(w.streamable),d.log("Server shutdown complete"),process.exit(0)})}async function te(e){for(let n in e)try{await e[n]?.close(),delete e[n]}catch(t){console.error(`Error closing transport for session ${n}:`,t)}}import{McpServer as jt}from"@modelcontextprotocol/sdk/server/mcp.js";import{z as y}from"zod";import N from"fs";import{isTruthy as oe}from"remeda";function b(e,n,t){if(!(typeof n=="object"&&n!==null)||!(e in n))return!1;let i=n[e];return t?t(i):i!==void 0}function W(e){return typeof e=="object"&&!!e&&"clipsContent"in e&&typeof e.clipsContent=="boolean"}function ie(e){return typeof e=="object"&&!!e&&"absoluteBoundingBox"in e&&typeof e.absoluteBoundingBox=="object"&&!!e.absoluteBoundingBox&&"x"in e.absoluteBoundingBox&&"y"in e.absoluteBoundingBox&&"width"in e.absoluteBoundingBox&&"height"in e.absoluteBoundingBox}function se(e){return typeof e=="object"&&e!==null&&"top"in e&&"right"in e&&"bottom"in e&&"left"in e}function U(e,n){let t=n;return typeof n=="object"&&!!n&&e in t&&typeof t[e]=="object"&&!!t[e]&&"x"in t[e]&&"y"in t[e]&&"width"in t[e]&&"height"in t[e]}function re(e){return Array.isArray(e)&&e.length===4&&e.every(n=>typeof n=="number")}import F from"fs";import Me from"path";async function K(e,n,t){try{F.existsSync(n)||F.mkdirSync(n,{recursive:!0});let o=Me.join(n,e),i=await fetch(t,{method:"GET"});if(!i.ok)throw new Error(`Failed to download image: ${i.statusText}`);let s=F.createWriteStream(o),r=i.body?.getReader();if(!r)throw new Error("Failed to get response body");return new Promise((a,l)=>{let g=async()=>{try{for(;;){let{done:c,value:p}=await r.read();if(c){s.end();break}s.write(p)}a(o)}catch(c){s.end(),F.unlink(o,()=>{}),l(c)}};s.on("error",c=>{r.cancel(),F.unlink(o,()=>{}),l(new Error(`Failed to write image: ${c.message}`))}),g()})}catch(o){let i=o instanceof Error?o.message:String(o);throw new Error(`Error downloading image: ${i}`)}}function O(e){if(typeof e!="object"||e===null)return e;if(Array.isArray(e))return e.map(t=>O(t));let n={};for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t)){let o=e[t],i=O(o);i!==void 0&&!(Array.isArray(i)&&i.length===0)&&!(typeof i=="object"&&i!==null&&Object.keys(i).length===0)&&(n[t]=i)}return n}function ae(e,n=1){let t=Math.round(e.r*255),o=Math.round(e.g*255),i=Math.round(e.b*255),s=Math.round(n*e.a*100)/100;return{hex:"#"+((1<<24)+(t<<16)+(o<<8)+i).toString(16).slice(1).toUpperCase(),opacity:s}}function P(e,n=1){let t=Math.round(e.r*255),o=Math.round(e.g*255),i=Math.round(e.b*255),s=Math.round(n*e.a*100)/100;return`rgba(${t}, ${o}, ${i}, ${s})`}function le(e){let n=0;if(e.length===0)return"0";for(let t=0;t<e.length;t++){let o=e.charCodeAt(t);n=(n<<5)-n+o,n|=0}return"h"+Math.abs(n).toString(36).substring(0,6)}function j(e,{ignoreZero:n=!0,suffix:t="px"}={}){let{top:o,right:i,bottom:s,left:r}=e;if(!(n&&o===0&&i===0&&s===0&&r===0))return o===i&&i===s&&s===r?`${o}${t}`:i===r?o===s?`${o}${t} ${i}${t}`:`${o}${t} ${i}${t} ${s}${t}`:`${o}${t} ${i}${t} ${s}${t} ${r}${t}`}function V(e){if(e.type==="IMAGE")return{type:"IMAGE",imageRef:e.imageRef,scaleMode:e.scaleMode};if(e.type==="SOLID"){let{hex:n,opacity:t}=ae(e.color,e.opacity);return Math.abs(t-1)<.001?n:P(e.color,t)}else{if(["GRADIENT_LINEAR","GRADIENT_RADIAL","GRADIENT_ANGULAR","GRADIENT_DIAMOND"].includes(e.type))return{type:e.type,gradientHandlePositions:e.gradientHandlePositions,gradientStops:e.gradientStops.map(({position:n,color:t})=>({position:n,color:ae(t)}))};throw new Error(`Unknown paint type: ${e.type}`)}}function I(e){return e.visible??!0}function pe(e,n){let t=Ge(e),o=ze(e,n,t.mode)||{};return{...t,...o}}function ce(e,n){if(n&&n.mode!=="none"){let{children:t,mode:o,axis:i}=n,s=He(i,o);if(t.length>0&&t.reduce((a,l)=>a?"layoutPositioning"in l&&l.layoutPositioning==="ABSOLUTE"?!0:s==="horizontal"?"layoutSizingHorizontal"in l&&l.layoutSizingHorizontal==="FILL":s==="vertical"?"layoutSizingVertical"in l&&l.layoutSizingVertical==="FILL":!1:!1,!0))return"stretch"}switch(e){case"MIN":return;case"MAX":return"flex-end";case"CENTER":return"center";case"SPACE_BETWEEN":return"space-between";case"BASELINE":return"baseline";default:return}}function Be(e){switch(e){case"MIN":return;case"MAX":return"flex-end";case"CENTER":return"center";case"STRETCH":return"stretch";default:return}}function ge(e){if(e==="FIXED")return"fixed";if(e==="FILL")return"fill";if(e==="HUG")return"hug"}function He(e,n){switch(e){case"primary":switch(n){case"row":return"horizontal";case"column":return"vertical"}case"counter":switch(n){case"row":return"horizontal";case"column":return"vertical"}}}function Ge(e){if(!W(e))return{mode:"none"};let n={mode:!e.layoutMode||e.layoutMode==="NONE"?"none":e.layoutMode==="HORIZONTAL"?"row":"column"},t=[];return e.overflowDirection?.includes("HORIZONTAL")&&t.push("x"),e.overflowDirection?.includes("VERTICAL")&&t.push("y"),t.length>0&&(n.overflowScroll=t),n.mode==="none"||(n.justifyContent=ce(e.primaryAxisAlignItems??"MIN",{children:e.children,axis:"primary",mode:n.mode}),n.alignItems=ce(e.counterAxisAlignItems??"MIN",{children:e.children,axis:"counter",mode:n.mode}),n.alignSelf=Be(e.layoutAlign),n.wrap=e.layoutWrap==="WRAP"?!0:void 0,n.gap=e.itemSpacing?`${e.itemSpacing??0}px`:void 0,(e.paddingTop||e.paddingBottom||e.paddingLeft||e.paddingRight)&&(n.padding=j({top:e.paddingTop??0,right:e.paddingRight??0,bottom:e.paddingBottom??0,left:e.paddingLeft??0}))),n}function ze(e,n,t){if(!ie(e))return;let o={mode:t};if(o.sizing={horizontal:ge(e.layoutSizingHorizontal),vertical:ge(e.layoutSizingVertical)},W(n)&&(n?.layoutMode==="NONE"||e.layoutPositioning==="ABSOLUTE"))return e.layoutPositioning==="ABSOLUTE"&&(o.position="absolute"),e.absoluteBoundingBox&&n.absoluteBoundingBox&&(o.locationRelativeToParent={x:e.absoluteBoundingBox.x-(n?.absoluteBoundingBox?.x??e.absoluteBoundingBox.x),y:e.absoluteBoundingBox.y-(n?.absoluteBoundingBox?.y??e.absoluteBoundingBox.y)}),o;if(U("absoluteBoundingBox",e)&&U("absoluteBoundingBox",n)){let i={};t==="row"?(!e.layoutGrow&&e.layoutSizingHorizontal=="FIXED"&&(i.width=e.absoluteBoundingBox.width),e.layoutAlign!=="STRETCH"&&e.layoutSizingVertical=="FIXED"&&(i.height=e.absoluteBoundingBox.height)):t==="column"&&(e.layoutAlign!=="STRETCH"&&e.layoutSizingHorizontal=="FIXED"&&(i.width=e.absoluteBoundingBox.width),!e.layoutGrow&&e.layoutSizingVertical=="FIXED"&&(i.height=e.absoluteBoundingBox.height),e.preserveRatio&&(i.aspectRatio=e.absoluteBoundingBox?.width/e.absoluteBoundingBox?.height)),Object.keys(i).length>0&&(o.dimensions=i)}return o}function me(e){if(!e)return"No layout defined.";let n=[];if(e.mode){let t="Arrangement: ";e.mode==="row"?t+="Horizontal (Row)":e.mode==="column"?t+="Vertical (Column)":t+="None",n.push(t+".")}if((e.mode==="row"||e.mode==="column")&&(e.justifyContent&&n.push(`Justify Content: ${e.justifyContent}.`),e.alignItems&&n.push(`Align Items: ${e.alignItems}.`),e.gap&&n.push(`Item Spacing (Gap): ${e.gap}.`),e.wrap&&n.push("Wrapping: Enabled.")),e.alignSelf&&n.push(`Align Self: ${e.alignSelf}.`),e.padding&&n.push(`Padding: ${e.padding}.`),e.sizing){let t=[];e.sizing.horizontal&&t.push(`Horizontal: ${e.sizing.horizontal}`),e.sizing.vertical&&t.push(`Vertical: ${e.sizing.vertical}`),t.length>0&&n.push(`Sizing: ${t.join(", ")}.`)}if(e.dimensions){let t=[];e.dimensions.width!==void 0&&t.push(`Width: ${e.dimensions.width}px`),e.dimensions.height!==void 0&&t.push(`Height: ${e.dimensions.height}px`),e.dimensions.aspectRatio!==void 0&&t.push(`Aspect Ratio: ${e.dimensions.aspectRatio}`),t.length>0&&n.push(`Dimensions: ${t.join(", ")}.`)}return e.position&&n.push(`Positioning: ${e.position}.`),e.position==="absolute"&&e.locationRelativeToParent&&n.push(`Offset: X: ${e.locationRelativeToParent.x}px, Y: ${e.locationRelativeToParent.y}px.`),e.overflowScroll&&e.overflowScroll.length>0&&n.push(`Overflow Scroll: ${e.overflowScroll.join(", ")}.`),n.length>0?n.join(" "):"Basic or undefined layout properties."}function de(e){let n={colors:[]};return b("strokes",e)&&Array.isArray(e.strokes)&&e.strokes.length&&(n.colors=e.strokes.filter(I).map(V)),b("strokeWeight",e)&&typeof e.strokeWeight=="number"&&e.strokeWeight>0&&(n.strokeWeight=`${e.strokeWeight}px`),b("strokeDashes",e)&&Array.isArray(e.strokeDashes)&&e.strokeDashes.length&&(n.strokeDashes=e.strokeDashes),b("individualStrokeWeights",e,se)&&(n.strokeWeight=j(e.individualStrokeWeights)),n}function ue(e){if(!b("effects",e))return{};let n=e.effects.filter(l=>l.visible),t=n.filter(l=>l.type==="DROP_SHADOW").map(Le),o=n.filter(l=>l.type==="INNER_SHADOW").map(_e),i=[...t,...o].join(", "),s=n.filter(l=>l.type==="LAYER_BLUR").map(fe).join(" "),r=n.filter(l=>l.type==="BACKGROUND_BLUR").map(fe).join(" "),a={};return i&&(a.boxShadow=i),s&&(a.filter=s),r&&(a.backdropFilter=r),a}function Le(e){return`${e.offset.x}px ${e.offset.y}px ${e.radius}px ${e.spread??0}px ${P(e.color)}`}function _e(e){return`inset ${e.offset.x}px ${e.offset.y}px ${e.radius}px ${e.spread??0}px ${P(e.color)}`}function fe(e){return`blur(${e.radius}px)`}function J(e){let{name:n,lastModified:t,thumbnailUrl:o}=e,i,s;"document"in e?(i=Object.values(e.document.children),e.styles&&(s=e.styles)):i=Object.values(e.nodes).map(l=>l.document);let r={styles:{},components:{}},a=i.filter(I).map(l=>ye(r,l,void 0,s)).filter(l=>l!=null);return{name:n,lastModified:t,thumbnailUrl:o||"",nodes:a,globalVars:r}}function We(e){return e?e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/[^a-zA-Z0-9]+/g,"-").replace(/^-+|-+$/g,"").toLowerCase():""}function A(e,n,t,o,i){let[s]=Object.entries(e.styles).find(([c,p])=>JSON.stringify(p)===JSON.stringify(n))??[];if(s)return s;let r,a,l=o&&i&&i[o]?.name;if(l)a=`${t}_${We(l)}`;else{let c=JSON.stringify(n),p=le(c);a=`${t}_${p}`}let g=a;if(e.styles[g]){let c=1;for(g=`${a}_${c}`;e.styles[g];)c++,g=`${a}_${c}`}return r=g,e.styles[r]=n,r}function ye(e,n,t,o){let{id:i,name:s,type:r}=n,a={id:i,name:s,type:r};if(r==="INSTANCE"&&n.componentId&&(a.mainComponentId=n.componentId),b("style",n)&&Object.keys(n.style).length){let p=n.style,f={fontFamily:p.fontFamily,fontWeight:p.fontWeight,fontSize:p.fontSize,lineHeight:p.lineHeightPx&&p.fontSize?`${p.lineHeightPx/p.fontSize}em`:void 0,letterSpacing:p.letterSpacing&&p.letterSpacing!==0&&p.fontSize?`${p.letterSpacing/p.fontSize*100}%`:void 0,textCase:p.textCase,textAlignHorizontal:p.textAlignHorizontal,textAlignVertical:p.textAlignVertical},u;"styles"in n&&n.styles&&(u=n.styles.TEXT),a.textStyle=A(e,f,"text",u,o)}if(b("fills",n)&&Array.isArray(n.fills)&&n.fills.length){let p=n.fills.map(V),f;"styles"in n&&n.styles&&(f=n.styles.FILL),a.fills=A(e,p,"fill",f,o)}let l=de(n);if(l.colors.length){let p;"styles"in n&&n.styles&&(p=n.styles.STROKE),a.strokes=A(e,l,"stroke",p,o)}let g=ue(n);if(Object.keys(g).length){let p;"styles"in n&&n.styles&&(p=n.styles.EFFECT),a.effects=A(e,g,"effect",p,o)}let c=pe(n,t);if(Object.keys(c).length>1&&(a.layout=A(e,c,"layout",void 0,o)),b("characters",n,oe)&&(a.text=n.characters),b("opacity",n)&&typeof n.opacity=="number"&&n.opacity!==1&&(a.opacity=n.opacity),b("cornerRadius",n)&&typeof n.cornerRadius=="number"&&(a.borderRadius=`${n.cornerRadius}px`),b("rectangleCornerRadii",n,re)&&(a.borderRadius=`${n.rectangleCornerRadii[0]}px ${n.rectangleCornerRadii[1]}px ${n.rectangleCornerRadii[2]}px ${n.rectangleCornerRadii[3]}px`),b("children",n)&&n.children.length>0){let p=n.children.filter(I).map(f=>ye(e,f,n,o)).filter(f=>f!=null);p.length&&(a.children=p)}return r==="VECTOR"&&(a.type="IMAGE-SVG"),O(a)}import Ue from"js-yaml";var M=class{apiKey;baseUrl="https://api.figma.com/v1";constructor(n){this.apiKey=n}async request(n){if(typeof fetch!="function")throw new Error("The MCP server is being run in a Node.js environment where `fetch` is not available. You won't be able to access any data related to the Figma file.\n\nAs the coding AI assistant, PLEASE ABORT THE CURRENT REQUEST. No alternate approaches will work. Help the user fix this issue so you can proceed by letting them know that they need to run the MCP server with Node.js version 18 or higher.");try{d.log(`Calling ${this.baseUrl}${n}`);let t=await fetch(`${this.baseUrl}${n}`,{headers:{"X-Figma-Token":this.apiKey}});if(!t.ok)throw{status:t.status,err:t.statusText||"Unknown error"};return await t.json()}catch(t){throw t.status?t:t instanceof Error?new Error(`Failed to make request to Figma API: ${t.message}`):new Error(`Failed to make request to Figma API: ${t}`)}}async getImageFills(n,t,o){if(t.length===0)return[];let i=[],s=`/files/${n}/images`,r=await this.request(s),{images:a={}}=r.meta;return i=t.map(async({imageRef:l,fileName:g})=>{let c=a[l];return c?K(g,o,c):""}),Promise.all(i)}async getImages(n,t,o){let i=t.filter(({fileType:c})=>c==="png").map(({nodeId:c})=>c),s=i.length>0?this.request(`/images/${n}?ids=${i.join(",")}&scale=2&format=png`).then(({images:c={}})=>c):{},r=t.filter(({fileType:c})=>c==="svg").map(({nodeId:c})=>c),a=r.length>0?this.request(`/images/${n}?ids=${r.join(",")}&format=svg`).then(({images:c={}})=>c):{},l=await Promise.all([s,a]).then(([c,p])=>({...c,...p})),g=t.map(({nodeId:c,fileName:p})=>{let f=l[c];return f?K(p,o,f):!1}).filter(c=>!!c);return Promise.all(g)}async getFile(n,t){try{let o=`/files/${n}${t?`?depth=${t}`:""}`;d.log(`Retrieving Figma file: ${n} (depth: ${t??"default"})`);let i=await this.request(o);d.log("Got response");let s=J(i);return D("figma-raw.yml",i),D("figma-simplified.yml",s),s}catch(o){throw console.error("Failed to get file:",o),o}}async getNode(n,t,o){let i=`/files/${n}/nodes?ids=${t}${o?`&depth=${o}`:""}`,s=await this.request(i);d.log("Got response from getNode, now parsing."),D("figma-raw.yml",s);let r=J(s);return D("figma-simplified.yml",r),r}async getVariables(n,t="local"){try{let o=`/files/${n}/variables/${t}`;d.log(`Retrieving Figma variables: ${n} (scope: ${t})`);let i=await this.request(o);return d.log("Got variables response"),D("figma-variables-raw.yml",i),i}catch(o){throw console.error("Failed to get variables:",o),o}}};function D(e,n){try{if(process.env.NODE_ENV!=="development")return;let t="logs";try{N.accessSync(process.cwd(),N.constants.W_OK)}catch(o){d.log("Failed to write logs:",o);return}N.existsSync(t)||N.mkdirSync(t),N.writeFileSync(`${t}/${e}`,Ue.dump(n))}catch(t){console.debug("Failed to write logs:",t)}}function Ke(e){return e?e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/[^a-zA-Z0-9\-]+/g,"-").replace(/^-+|-+$/g,"").toLowerCase():""}function Je(e,n,t){let o=e,i=null,s={value:n};if(e.startsWith("fill_")&&Array.isArray(n)){let r=n;if(i="colors",r.length===1){let a=r[0];typeof a=="string"?s={value:a,type:"color"}:a.imageRef?s={value:`Image Fill (Ref: ${a.imageRef})`,type:"image",imageRef:a.imageRef}:a.rgba?s={value:a.rgba,type:"color"}:a.hex?s={value:a.hex,type:"color"}:s={value:JSON.stringify(a),type:"complex_fill"}}else r.length>1?s={value:r.map(a=>typeof a=="string"?a:a.imageRef?`Image Fill (Ref: ${a.imageRef})`:a.rgba||a.hex||JSON.stringify(a)),type:"multi_color"}:s={value:"empty_fill",type:"color"}}else if(e.startsWith("text_")&&typeof n=="object"&&!Array.isArray(n))i="typography",s={value:n,type:"typography"};else if(e.startsWith("effect_")&&typeof n=="object"&&!Array.isArray(n)){i="effects";let r=n;s={value:r.boxShadow||JSON.stringify(r),type:"effect"},r.boxShadow?s.value=r.boxShadow:r.filter?s.value=r.filter:r.backdropFilter?s.value=r.backdropFilter:s.value=JSON.stringify(r)}else if(e.startsWith("layout_")&&typeof n=="object"&&!Array.isArray(n)){let r=n;r.gap&&(i="spacing",s={value:r.gap,type:"spacing"})}else if(e.startsWith("stroke_")&&typeof n=="object"&&!Array.isArray(n)){let r=n;if(r.colors&&r.colors.length===1){let a=r.colors[0];typeof a=="string"?(i="colors",s={value:a,type:"borderColor",weight:r.strokeWeight}):a.rgba?(i="colors",s={value:a.rgba,type:"borderColor",weight:r.strokeWeight}):a.hex&&(i="colors",s={value:a.hex,type:"borderColor",weight:r.strokeWeight})}}else typeof n=="string"&&(n.startsWith("#")||n.startsWith("rgb"))&&(i="colors",s={value:n,type:"color"});return{category:i,name:o,token:s}}function k(e){let n={colors:{},typography:{},effects:{},spacing:{}};if(e.globalVars&&e.globalVars.styles)for(let t in e.globalVars.styles){let o=e.globalVars.styles[t],{category:i,name:s,token:r}=Je(t,o,e.globalVars);if(i&&n[i]){let a=Ke(s);a||(a="unnamed-token");let l=1,g=a;for(;n[i]?.[a];)a=`${g}-${l}`,l++;n[i][a]=r}}return Object.keys(n).forEach(t=>{let o=t;n[o]&&Object.keys(n[o]).length===0&&delete n[o]}),n}function B(e){let n=[],t={},o=qe(e),i=Ye(e);o.forEach(g=>{let c=Xe(g,e,i);c&&(n.push(c),t[c.id]=rt(c,e,n))});let s=at(n,t),r=lt(n),a=ct(n),l=gt(n,s,a);return{components:n,relationships:t,designPatterns:s,atomicHierarchy:r,implementationReadiness:a,summary:l}}function qe(e){let n=[];function t(o){o.type==="COMPONENT"&&n.push(o),o.children&&o.children.forEach(t)}return e.nodes.forEach(t),n}function Ye(e){let n=[];function t(o){o.type==="INSTANCE"&&n.push(o),o.children&&o.children.forEach(t)}return e.nodes.forEach(t),n}function Xe(e,n,t){if(!e.name)return null;let o=t.filter(p=>p.componentId===e.id||p.name?.includes(e.name)),i=Ze(e,o),s=Qe(e,i),r=et(o,n),a=tt(e),l=nt(e),g=ot(e,s,a),c=st(e,o);return{id:e.id,name:e.name,description:e.description||void 0,category:c,variants:i,props:s,usage:r,styling:a,accessibility:l,codeHints:g}}function Ze(e,n){let t=[];return t.push({name:"Default",properties:{},nodeId:e.id,description:"Default state of the component"}),n.forEach(o=>{if(o.componentProperties){let i=o.componentProperties,s=Object.values(i).join(" / ")||"Variant";t.push({name:s,properties:i,nodeId:o.id,description:`Variant with properties: ${JSON.stringify(i)}`})}}),t.filter((o,i,s)=>i===s.findIndex(r=>r.name===o.name))}function Qe(e,n){let t=[],o=new Set;return n.forEach(i=>{Object.keys(i.properties).forEach(s=>o.add(s))}),o.forEach(i=>{let s=n.map(a=>a.properties[i]).filter(Boolean).filter((a,l,g)=>g.indexOf(a)===l),r="string";s.every(a=>a==="true"||a==="false")?r="boolean":s.every(a=>!isNaN(Number(a)))?r="number":s.length>1&&s.length<=10&&(r="enum"),t.push({name:i,type:r,values:r==="enum"?s:void 0,default:s[0],required:!1,description:`Component property: ${i}`})}),t}function et(e,n){let t=new Set,o=new Set;return e.forEach(i=>{let s=pt(i,n);s&&t.add(s),mt(i,n).forEach(a=>o.add(a))}),{frequency:e.length,contexts:Array.from(t),commonPairings:Array.from(o),layoutRoles:dt(e)}}function tt(e){let n=!!(e.reactions&&e.reactions.length>0);return{hasStates:n,states:n?["default","hover","active","disabled"]:["default"],responsiveBehavior:ft(e),spacing:{internal:ut(e),external:yt(e)},colorTokens:ht(e),typographyTokens:St(e)}}function nt(e){let n=[],t=[],o=!!(e.name&&e.name.trim());o||(n.push("Component lacks proper naming"),t.push("Add descriptive component name"));let i=e.type==="FRAME",s;return e.name?.toLowerCase().includes("button")?s="button":e.name?.toLowerCase().includes("input")?s="textbox":e.name?.toLowerCase().includes("card")&&(s="article"),{role:s,hasProperLabels:o,keyboardNavigable:i,issues:n,recommendations:t}}function ot(e,n,t){let o="div";e.name?.toLowerCase().includes("button")?o="button":e.name?.toLowerCase().includes("input")?o="input":e.name?.toLowerCase().includes("link")&&(o="a");let i=["functional-component",t.hasStates?"state-management":"stateless",n.length>0?"prop-types":"no-props"],s={};return n.forEach(r=>{s[r.name]=r.type==="boolean"?"boolean":"string"}),{htmlElement:o,reactPatterns:i,cssApproach:"css-modules",propsMapping:s,stateManagement:t.hasStates?["useState","handlers"]:[],examples:it(e,n,o)}}function it(e,n,t){let o=[],i=n.map(s=>`${s.name}="${s.default||"value"}"`).join(" ");return o.push(`<${e.name} ${i} />`),t!=="input"&&o.push(`<${e.name} ${i}>Content</${e.name}>`),o}function st(e,n){let t=e.name?.toLowerCase()||"";return t.includes("button")||t.includes("input")||t.includes("icon")||t.includes("avatar")?"atom":t.includes("card")||t.includes("form")||t.includes("search")||n.length>5?"molecule":t.includes("header")||t.includes("navigation")||t.includes("sidebar")||n.length>20?"organism":t.includes("template")||t.includes("layout")||t.includes("page")?"template":"molecule"}function rt(e,n,t){return{parent:"",children:[],siblings:[],dependsOn:[],usedBy:[]}}function at(e,n){let t=[],o=e.filter(s=>s.name.toLowerCase().includes("card"));o.length>0&&t.push({name:"Card Pattern",description:"Reusable card components for content display",components:o.map(s=>s.name),usage:"Use for displaying grouped content with consistent styling",implementation:"Implement as flexible container with configurable content slots"});let i=e.filter(s=>s.name.toLowerCase().includes("button"));return i.length>0&&t.push({name:"Button System",description:"Consistent button variations across the design",components:i.map(s=>s.name),usage:"Use appropriate button variant based on hierarchy and context",implementation:"Implement with variant prop system for different styles"}),t}function lt(e){return{atoms:e.filter(n=>n.category==="atom").map(n=>n.name),molecules:e.filter(n=>n.category==="molecule").map(n=>n.name),organisms:e.filter(n=>n.category==="organism").map(n=>n.name),templates:e.filter(n=>n.category==="template").map(n=>n.name),pages:e.filter(n=>n.category==="page").map(n=>n.name)}}function ct(e){let n=e.filter(i=>i.variants.length>0&&i.props.length>0&&i.accessibility.issues.length===0),t=e.filter(i=>i.props.length===0||i.variants.length<=1),o=e.filter(i=>i.accessibility.issues.length>0);return{readyToImplement:n,needsSpecification:t,hasIssues:o,suggestions:["Add more variant examples for better prop inference","Ensure all interactive components have proper accessibility attributes","Consider breaking down complex organisms into smaller molecules"]}}function gt(e,n,t){let o={atom:e.filter(a=>a.category==="atom").length,molecule:e.filter(a=>a.category==="molecule").length,organism:e.filter(a=>a.category==="organism").length,template:e.filter(a=>a.category==="template").length,page:e.filter(a=>a.category==="page").length},i=Math.min(100,e.length*10+n.length*5),s=Math.min(100,t.readyToImplement.length/e.length*100),r="medium";return e.length<10&&(r="low"),e.length>30&&(r="high"),{totalComponents:e.length,byCategory:o,complexityScore:i,consistencyScore:s,implementationEffort:r,keyRecommendations:[`Found ${e.length} components across ${n.length} design patterns`,`${t.readyToImplement.length} components are ready for implementation`,`Focus on implementing ${o.atom} atoms first as building blocks`,s<70?"Consider standardizing component variants and properties":"Component system shows good consistency"]}}function pt(e,n){return"Page"}function mt(e,n){return[]}function dt(e){return["content","layout"]}function ft(e){return"flexible"}function ut(e){return["8px","16px"]}function yt(e){return["12px","24px"]}function ht(e){return["primary-500","neutral-100"]}function St(e){return["body-medium","heading-small"]}import q from"fs/promises";async function Y(e,n,t){let o={added:[],removed:[],modified:[],unchanged:[]},i=Object.keys(e.colors),s=Object.keys(n.colors);s.forEach(l=>{i.includes(l)||o.added.push(`color.${l}`)}),i.forEach(l=>{s.includes(l)||o.removed.push(`color.${l}`)}),i.forEach(l=>{if(s.includes(l)){let g=typeof e.colors[l]=="string"?e.colors[l]:e.colors[l].value,c=typeof n.colors[l]=="string"?n.colors[l]:n.colors[l].value;JSON.stringify(g)!==JSON.stringify(c)?o.modified.push({name:`color.${l}`,changes:[`Value changed from ${JSON.stringify(g)} to ${JSON.stringify(c)}`]}):o.unchanged.push(`color.${l}`)}});let r=Object.keys(e.typography),a=Object.keys(n.typography);return a.forEach(l=>{r.includes(l)||o.added.push(`typography.${l}`)}),r.forEach(l=>{if(!a.includes(l))o.removed.push(`typography.${l}`);else{let g=e.typography[l].value,c=n.typography[l].value;JSON.stringify(g)!==JSON.stringify(c)?o.modified.push({name:`typography.${l}`,changes:["Typography properties changed"]}):o.unchanged.push(`typography.${l}`)}}),t&&await q.writeFile(t,JSON.stringify(o,null,2)),o}function H(e){let n=[],t=[],o=0;Object.keys(e.colors).forEach(a=>{o++,a.match(/^(primary|secondary|neutral|success|warning|error|info)-\d{2,3}$/)||t.push({rule:"color-naming",component:`color.${a}`,issue:"Color name should follow pattern: {semantic}-{weight} (e.g., primary-500)"})});let i=Object.values(e.typography).map(a=>a.value.fontSize),s=[...new Set(i)];o++,s.length>8&&t.push({rule:"typography-scale",component:"typography",issue:`Too many font sizes (${s.length}). Consider consolidating to max 8 sizes.`}),Object.entries(e.spacing).forEach(([a,l])=>{o++;let g=parseInt(l.value);g&&g%4!==0&&g%8!==0&&t.push({rule:"spacing-scale",component:`spacing.${a}`,issue:`Spacing value ${g} should be multiple of 4 or 8 for consistency`})}),Object.entries(e.colors).forEach(([a,l])=>{o++;let g=typeof l=="string"?l:l.value;typeof g=="string"&&g.includes("#")&&a.includes("text")&&(g==="#ffffff"||g==="#fff")&&n.push({rule:"color-contrast",component:`color.${a}`,issue:"White text color may have contrast issues",severity:"warning"})});let r=o-n.length-t.length;return{passed:n.length===0,errors:n,warnings:t,summary:{totalChecks:o,passed:r,failed:n.length,warnings:t.length}}}function G(e){let n=[];Object.entries(e.typography).forEach(([r,a])=>{let l=parseFloat(a.value.fontSize),g=a.value.fontWeight?parseInt(String(a.value.fontWeight)):400;l<12&&n.push({type:"text-size",severity:"error",component:`typography.${r}`,issue:`Font size ${l}px is below WCAG minimum (12px)`,suggestion:"Use minimum 12px for any text, 14px recommended for body text"}),r.includes("body")&&l<14&&n.push({type:"text-size",severity:"warning",component:`typography.${r}`,issue:`Body text ${l}px is below recommended minimum (14px)`,suggestion:"Use 14px or larger for body text to improve readability"});let c=l>=18||l>=14&&g>=700;if(g<=200&&l<16&&n.push({type:"text-size",severity:"warning",component:`typography.${r}`,issue:`Thin font weight (${g}) with small size (${l}px) may be hard to read`,suggestion:"Use font-weight 300+ for small text, or increase font size"}),a.value.lineHeight){let p=parseFloat(String(a.value.lineHeight));p<1.2&&n.push({type:"text-size",severity:"warning",component:`typography.${r}`,issue:`Line height ${p} is too tight, may affect readability`,suggestion:"Use line-height of 1.4-1.6 for body text, minimum 1.2 for headings"})}});let t=Object.entries(e.colors),o=t.filter(([r])=>r.includes("text")||r.includes("foreground")||r.includes("content")),i=t.filter(([r])=>r.includes("background")||r.includes("surface")||r.includes("bg"));return o.forEach(([r,a])=>{let l=typeof a=="string"?a:a.value;if(typeof l=="string"){let g=he(l,"#ffffff");g<4.5&&n.push({type:"contrast",severity:g<3?"error":"warning",component:`color.${r}`,issue:`Contrast ratio ${g.toFixed(2)}:1 with white background is below WCAG AA (4.5:1)`,suggestion:g<3?"Use a darker color to meet WCAG AA standards (4.5:1) or AAA (7:1)":"Consider darkening color for better accessibility"}),i.forEach(([c,p])=>{let f=typeof p=="string"?p:p.value;if(typeof f=="string"){let u=he(l,f);if(u<4.5){let C=r.includes("heading")||r.includes("title")||r.includes("large"),$=C?3:4.5;u<$&&n.push({type:"contrast",severity:u<$*.8?"error":"warning",component:`color.${r}`,issue:`Contrast ratio ${u.toFixed(2)}:1 between ${r} and ${c} is below WCAG ${C?"AA large text (3:1)":"AA (4.5:1)"}`,suggestion:`Adjust colors to achieve ${C?"3:1":"4.5:1"} contrast ratio for WCAG AA compliance`})}}}),$t(l)&&n.push({type:"contrast",severity:"warning",component:`color.${r}`,issue:`Color ${l} is known to have poor contrast in many contexts`,suggestion:"Test this color against its intended backgrounds and ensure 4.5:1 contrast ratio"})}}),t.filter(([r])=>r.includes("success")||r.includes("error")||r.includes("warning")||r.includes("info")||r.includes("danger")||r.includes("alert")).length>0&&n.push({type:"color-only",severity:"warning",component:"color.status-colors",issue:"Status colors detected - ensure they are not the only way to convey information",suggestion:"Supplement status colors with icons, text labels, or other visual indicators"}),Object.entries(e.spacing).forEach(([r,a])=>{let l=parseFloat(a.value);(r.includes("button")||r.includes("touch")||r.includes("tap"))&&(l<44?n.push({type:"touch-target",severity:"error",component:`spacing.${r}`,issue:`Touch target size ${l}px is below WCAG minimum (44px)`,suggestion:"Use minimum 44x44px for touch targets, 48px recommended for better usability"}):l<48&&n.push({type:"touch-target",severity:"warning",component:`spacing.${r}`,issue:`Touch target size ${l}px meets minimum but could be larger`,suggestion:"Consider 48px or larger for optimal touch target size"}))}),n}function he(e,n){let t=Se(e),o=Se(n),i=Math.max(t,o),s=Math.min(t,o);return(i+.05)/(s+.05)}function Se(e){let n=bt(e);if(!n)return 0;let t=n.r/255,o=n.g/255,i=n.b/255,s=t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4),r=o<=.03928?o/12.92:Math.pow((o+.055)/1.055,2.4),a=i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4);return .2126*s+.7152*r+.0722*a}function bt(e){if(e=e.replace("#",""),e.length===3&&(e=e.split("").map(i=>i+i).join("")),e.length!==6)return null;let n=parseInt(e.substring(0,2),16),t=parseInt(e.substring(2,4),16),o=parseInt(e.substring(4,6),16);return{r:n,g:t,b:o}}function $t(e){return["#cccccc","#ccc","#d3d3d3","#dcdcdc","#f5f5f5","#ffff00","#00ffff","#ff00ff","#808080","#a0a0a0","#b0b0b0"].includes(e.toLowerCase())}async function be(e,n,t){let o=[],i="";try{switch(n){case"tailwind":i=Ct(e);break;case"css-variables":i=vt(e);break;case"style-dictionary":i=xt(e);break;case"figma-tokens":i=wt(e);break;default:throw new Error(`Unsupported format: ${n}`)}return await q.writeFile(t,i),{success:!0,outputPath:t,format:n,summary:{tokensProcessed:Object.keys(e.colors).length+Object.keys(e.typography).length+Object.keys(e.spacing).length,errors:o}}}catch(s){return o.push(s instanceof Error?s.message:"Unknown error"),{success:!1,outputPath:t,format:n,summary:{tokensProcessed:0,errors:o}}}}async function $e(e,n){try{let t=await q.readFile(n,"utf-8"),o;if(n.endsWith(".json"))o=JSON.parse(t);else if(n.endsWith(".js")||n.endsWith(".ts"))o=kt(t);else throw new Error("Unsupported code tokens file format");return await Y(e,o)}catch(t){throw new Error(`Failed to sync check: ${t instanceof Error?t.message:"Unknown error"}`)}}function Ct(e){let n={},t={},o={};return Object.entries(e.colors).forEach(([i,s])=>{let r=typeof s=="string"?s:s.value;n[i.replace("-","")]=Array.isArray(r)?r[0]:r}),Object.entries(e.typography).forEach(([i,s])=>{t[i]=s.value.fontSize}),Object.entries(e.spacing).forEach(([i,s])=>{o[i]=s.value}),`module.exports = {
  theme: {
    extend: {
      colors: ${JSON.stringify(n,null,6)},
      fontSize: ${JSON.stringify(t,null,6)},
      spacing: ${JSON.stringify(o,null,6)}
    }
  }
}`}function vt(e){let n=`:root {
`;return Object.entries(e.colors).forEach(([t,o])=>{let i=typeof o=="string"?o:o.value,s=Array.isArray(i)?i[0]:i;n+=`  --color-${t}: ${s};
`}),Object.entries(e.typography).forEach(([t,o])=>{n+=`  --font-size-${t}: ${o.value.fontSize};
`,o.value.fontWeight&&(n+=`  --font-weight-${t}: ${o.value.fontWeight};
`),o.value.lineHeight&&(n+=`  --line-height-${t}: ${o.value.lineHeight};
`)}),Object.entries(e.spacing).forEach(([t,o])=>{n+=`  --spacing-${t}: ${o.value};
`}),n+="}",n}function xt(e){let n={color:{},size:{},font:{}};return Object.entries(e.colors).forEach(([t,o])=>{let i=typeof o=="string"?o:o.value,s=t.split("-"),r=n.color;for(let a=0;a<s.length-1;a++)r[s[a]]||(r[s[a]]={}),r=r[s[a]];r[s[s.length-1]]={value:Array.isArray(i)?i[0]:i}}),JSON.stringify(n,null,2)}function wt(e){let n={};return Object.keys(e.colors).length>0&&(n.colors={},Object.entries(e.colors).forEach(([t,o])=>{let i=typeof o=="string"?o:o.value;n.colors[t]={value:Array.isArray(i)?i[0]:i,type:"color"}})),Object.keys(e.typography).length>0&&(n.typography={},Object.entries(e.typography).forEach(([t,o])=>{n.typography[t]={value:o.value,type:"typography"}})),JSON.stringify(n,null,2)}function kt(e){let n={colors:{},typography:{},effects:{},spacing:{}},t=/['"`]([a-zA-Z]+-\d+)['"`]\s*:\s*['"`](#[a-fA-F0-9]{6}|#[a-fA-F0-9]{3})['"`]/g,o;for(;(o=t.exec(e))!==null;)n.colors[o[1]]=o[2];return n}import h from"fs";import S from"path";function m(e){return e==null?"":String(e).replace(/`/g,"\\`").replace(/\$/g,"\\$")}var v="```";function X(e){return v+`json
`+JSON.stringify(e,null,2)+`
`+v}function z(e,n=".md"){return`${e.replace(/[\/\\s<>:"\|?*]+/g,"_")}${n}`}function T(e){return e?e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").replace(/[^a-zA-Z0-9\-]+/g,"-").replace(/^-+|-+$/g,"").toLowerCase():""}function Ce(e,n){console.log("Starting enhanced documentation generation..."),h.existsSync(n)||h.mkdirSync(n,{recursive:!0});let t,o,i,s=[];try{console.log("Generating design tokens for validation and accessibility..."),t=k(e),console.log("Tokens generated successfully")}catch(g){console.error("Error generating tokens:",g),t={colors:{},typography:{},spacing:{},effects:{}}}try{console.log("Performing component analysis..."),o=B(e),console.log("Component analysis completed:",o.summary)}catch(g){console.error("Error in component analysis:",g),o={summary:{totalComponents:0,complexityScore:0,consistencyScore:0,implementationEffort:"low",keyRecommendations:[]},atomicHierarchy:{atoms:[],molecules:[],organisms:[]},implementationReadiness:{readyToImplement:[],needsSpecification:[],hasIssues:[]},designPatterns:[]}}try{console.log("Validating design system..."),i=H(t),console.log("Validation completed:",i.passed)}catch(g){console.error("Error in validation:",g),i={passed:!1,summary:{totalChecks:0,passed:0,failed:0,warnings:0},errors:[],warnings:[]}}try{console.log("Checking accessibility compliance..."),s=G(t),console.log("Accessibility check completed:",s.length,"issues found")}catch(g){console.error("Error in accessibility check:",g),s=[]}try{console.log("Generating enhanced overview...");let g=Tt(e,n,o,i,s);h.writeFileSync(S.join(n,"_Overview.md"),g),console.log("Enhanced overview generated successfully")}catch(g){console.error("Error generating enhanced overview:",g);let c=`# Design System Overview: ${e.name}

*Last Modified:* ${e.lastModified}

Basic documentation generated due to analysis errors.`;h.writeFileSync(S.join(n,"_Overview.md"),c)}console.log("Generating global styles...");let r=S.join(n,"GlobalStyles");h.existsSync(r)||h.mkdirSync(r,{recursive:!0}),Rt(e,r),console.log("Generating components documentation...");let a=S.join(n,"Components");h.existsSync(a)||h.mkdirSync(a,{recursive:!0}),Et(e,a),console.log("Creating Analysis directory...");let l=S.join(n,"Analysis");h.existsSync(l)||h.mkdirSync(l,{recursive:!0}),console.log("Analysis directory created:",l);try{console.log("Generating component analysis markdown..."),Ft(o,l),console.log("Component analysis markdown generated")}catch(g){console.error("Error generating component analysis markdown:",g)}try{console.log("Generating validation report..."),It(i,l),console.log("Validation report generated")}catch(g){console.error("Error generating validation report:",g)}try{console.log("Generating accessibility report..."),At(s,l),console.log("Accessibility report generated")}catch(g){console.error("Error generating accessibility report:",g)}try{console.log("Generating implementation guide..."),Nt(o,t,l),console.log("Implementation guide generated")}catch(g){console.error("Error generating implementation guide:",g)}console.log("Enhanced documentation generation completed!")}function Tt(e,n,t,o,i){let s=`# Design System Overview: ${m(e.name)}

`;s+=`*Last Modified:* ${m(e.lastModified)}

`,e.thumbnailUrl&&(s+=`## Thumbnail
`,s+=`![Thumbnail](${m(e.thumbnailUrl)})

`),s+=`## System Health Summary

`,s+=`### Component Analysis
`,s+=`- **Total Components**: ${t.summary.totalComponents}
`,s+=`- **Atoms**: ${t.atomicHierarchy.atoms.length}
`,s+=`- **Molecules**: ${t.atomicHierarchy.molecules.length}
`,s+=`- **Organisms**: ${t.atomicHierarchy.organisms.length}
`,s+=`- **Complexity Score**: ${t.summary.complexityScore}/100
`,s+=`- **Consistency Score**: ${t.summary.consistencyScore}/100
`,s+=`- **Implementation Effort**: ${t.summary.implementationEffort.toUpperCase()}

`,s+=`### Validation Status
`;let r=o.passed?"\u2705 PASSED":"\u274C FAILED";s+=`- **Overall Status**: ${r}
`,s+=`- **Checks Passed**: ${o.summary.passed}/${o.summary.totalChecks}
`,s+=`- **Errors**: ${o.summary.failed}
`,s+=`- **Warnings**: ${o.summary.warnings}

`,s+=`### Accessibility Status
`;let a=i.filter(c=>c.severity==="error").length,l=i.filter(c=>c.severity==="warning").length;return s+=`- **Overall Status**: ${a===0?"\u2705 COMPLIANT":"\u274C ISSUES FOUND"}
`,s+=`- **Critical Issues**: ${a}
`,s+=`- **Warnings**: ${l}

`,s+=`## Table of Contents

`,s+=`- [Global Styles](./GlobalStyles/)
`,s+=`  - [Colors](./GlobalStyles/Colors.md)
`,s+=`  - [Typography](./GlobalStyles/Typography.md)
`,s+=`  - [Effects](./GlobalStyles/Effects.md)
`,s+=`  - [Layout & Spacing](./GlobalStyles/LayoutAndSpacing.md)
`,s+=`- [Components by Page](./Components/)
`,e.nodes&&e.nodes.length>0&&e.nodes.forEach(c=>{c.type==="CANVAS"&&(s+=`  - [${m(c.name)} Components](./Components/${z(c.name)})
`)}),s+=`- [Analysis Reports](./Analysis/)
`,s+=`  - [Component Analysis](./Analysis/ComponentAnalysis.md)
`,s+=`  - [Validation Report](./Analysis/ValidationReport.md)
`,s+=`  - [Accessibility Report](./Analysis/AccessibilityReport.md)
`,s+=`  - [Implementation Guide](./Analysis/ImplementationGuide.md)
`,s+=`
`,s}function Rt(e,n){if(!e.globalVars||!e.globalVars.styles||Object.keys(e.globalVars.styles).length===0){h.writeFileSync(S.join(n,"NoGlobalStyles.md"),"No global styles found in the design system.");return}let t=e.globalVars.styles,o={colors:{},typography:{},effects:{},layout:{}};for(let l in t){let g=t[l],c=T(l),p={internalId:l,def:g};if(l.startsWith("fill_"))o.colors[c]=p;else if(l.startsWith("text_"))o.typography[c]=p;else if(l.startsWith("effect_"))o.effects[c]=p;else if(l.startsWith("layout_"))o.layout[c]=p;else if(l.startsWith("stroke_")){let f=g;if(f.colors&&f.colors.length===1){let u=f.colors[0];(typeof u=="string"||typeof u=="object"&&(u.hex||u.rgba))&&(o.colors[`${c} (Border)`]=p)}}}let i=`## Color Styles

`;if(Object.keys(o.colors).length>0){i+=`| Token Name | Value | Preview (Hex/RGBA) | Details |
`,i+=`|------------|-------|--------------------|---------|
`;for(let l in o.colors){let{def:g}=o.colors[l],c=T(l.replace(/\s*\(Border\)$/i,"")),p=`<a name="${m(c)}"></a>`;if(Array.isArray(g)){let f=g;f.forEach((u,C)=>{let $="Complex Fill",x="-",E="";typeof u=="string"?($=m(u),x=m(u),E="Type: Direct Color String"):u.hex?($="Solid Color",x=m(u.hex),E="Type: Solid (Hex), Opacity: "+(u.opacity||1)):u.rgba?($="Solid Color",x=m(u.rgba),E="Type: Solid (RGBA), Opacity: "+(u.opacity||1)):u.imageRef?($="Image Fill",x="Image Ref: "+m(u.imageRef),E="Type: Image, Scale Mode: "+m(u.scaleMode)):($=m(u.type||"Complex Fill"),E=X(u));let Ee=f.length>1?`${l}-${C+1}`:l;i+=`| ${C===0?p:""}${m(Ee)} | ${$} | ${v}${x}${v} | ${E.replace(/\n/g,"<br/>")} |
`})}else{let f=g,u=f.colors[0],C="Complex Stroke",$="-",x="Weight: "+m(f.strokeWeight)+"px";typeof u=="string"?(C="Solid Border",$=m(u),x+=", Type: Direct Color String"):u.hex?(C="Solid Border",$=m(u.hex),x+=", Type: Solid (Hex), Opacity: "+(u.opacity||1)):u.rgba?(C="Solid Border",$=m(u.rgba),x+=", Type: Solid (RGBA), Opacity: "+(u.opacity||1)):(C="Complex Border Color",x+=", Color: "+X(u)),i+=`| ${p}${m(l)} | ${C} | ${v}${$}${v} | ${x.replace(/\n/g,"<br/>")} |
`}}}else i+=`No color styles found.
`;h.writeFileSync(S.join(n,"Colors.md"),i+`
`);let s=`## Typography Styles

`;if(Object.keys(o.typography).length>0){s+=`| Token Name | Font Family | Size | Weight | Line Height | Letter Spacing | Case | Align H | Align V |
`,s+=`|------------|-------------|------|--------|-------------|----------------|------|---------|---------|
`;for(let l in o.typography){let{def:g}=o.typography[l],c=g,p=`<a name="${m(T(l))}"></a>`;s+=`| ${p}${m(l)} | ${m(c.fontFamily)||"-"} | ${m(c.fontSize)||"-"}px | ${m(c.fontWeight)||"-"} | ${m(c.lineHeight)||"-"} | ${m(c.letterSpacing)||"-"} | ${m(c.textCase)||"-"} | ${m(c.textAlignHorizontal)||"-"} | ${m(c.textAlignVertical)||"-"} |
`}}else s+=`No typography styles found.
`;h.writeFileSync(S.join(n,"Typography.md"),s+`
`);let r=`## Effect Styles (Shadows, Blurs)

`;if(Object.keys(o.effects).length>0){r+=`| Token Name | Type | Details |
`,r+=`|------------|------|---------|
`;for(let l in o.effects){let{def:g}=o.effects[l],c=g,p=`<a name="${m(T(l))}"></a>`,f="Effect",u="";c.boxShadow&&(f="Box Shadow",u+="CSS: "+v+`css
box-shadow: `+m(c.boxShadow)+`;
`+v+"<br/>"),c.filter&&(f=c.boxShadow?"Mixed (Shadow & Filter)":"Filter",u+="CSS: "+v+`css
filter: `+m(c.filter)+`;
`+v+"<br/>"),c.backdropFilter&&(f=c.boxShadow||c.filter?"Mixed (Multiple)":"Backdrop Filter",u+="CSS: "+v+`css
backdrop-filter: `+m(c.backdropFilter)+`;
`+v+"<br/>"),u||(f="Complex Effect",u=X(c)),r+=`| ${p}${m(l)} | ${m(f)} | ${u.replace(/\n/g,"").replace(/<br\/>$/,"")} |
`}}else r+=`No effect styles found.
`;h.writeFileSync(S.join(n,"Effects.md"),r+`
`);let a=`## Layout & Spacing Styles

`;if(Object.keys(o.layout).length>0){a+=`| Token Name | Details |
`,a+=`|------------|---------|
`;for(let l in o.layout){let{def:g}=o.layout[l],c=g,p=`<a name="${m(T(l))}"></a>`;a+=`| ${p}${m(l)} | ${m(me(c))} |
`}}else a+=`No layout/spacing styles found.
`;h.writeFileSync(S.join(n,"LayoutAndSpacing.md"),a+`
`)}function Et(e,n){if(!e.nodes||e.nodes.length===0){h.writeFileSync(S.join(n,"NoPagesFound.md"),"No pages (canvases) found in the Figma file.");return}e.nodes.forEach(t=>{if(t.type==="CANVAS"){let o=`# Page: ${m(t.name)}

`;o+=`*ID: ${m(t.id)}*

`,t.children&&t.children.length>0?o+=Z(t.children,0,e.globalVars,t.id):o+=`No components or top-level frames found on this page.
`,h.writeFileSync(S.join(n,z(t.name)),o)}else{let o=`# Node: ${m(t.name)} (Type: ${m(t.type)})

`;o+=`This top-level node is not a 'CANVAS'. Its children are listed below if any.

`,t.children&&t.children.length>0?o+=Z(t.children,0,e.globalVars,t.id):o+=`No children found for this node.
`,h.writeFileSync(S.join(n,z(`${t.type}_${t.name}`)),o)}})}function Z(e,n,t,o){let i="",s="  ".repeat(n);for(let r of e){let a="",l=`component-${o}-${m(r.id)}`;if(r.type==="COMPONENT"&&(a=`<a name="${l}"></a>**COMPONENT DEFINITION:** `),i+=`${s}- ${a}**${m(r.name)}** (Type: ${m(r.type)}, ID: ${m(r.id)})
`,r.opacity!==void 0&&r.opacity!==1&&(i+=`${s}  - Opacity: ${r.opacity}
`),r.borderRadius&&(i+=`${s}  - BorderRadius: ${m(r.borderRadius)}
`),r.type==="TEXT"&&r.text&&(i+=`${s}  - Text Content: "${m(r.text)}"
`),r.type==="INSTANCE"){let c="  - (Instance of a component.";if(r.mainComponentId){let p=t.components?.[r.mainComponentId]?.id.split(";")[0],f=`../${z(p||"UnknownPage")}#component-${p||"UnknownPage"}-${m(r.mainComponentId)}`;if(c+=` Main Component ID: [${m(r.mainComponentId)}](${f}).`,t&&t.components&&t.components[r.mainComponentId]){let u=t.components[r.mainComponentId];c+=` (Main Component Name: "${m(u.name)}"`,u.description&&(c+=`, Description: "${m(u.description)}"`),c+=")"}}c+=` Further details depend on main component definition.)
`,i+=s+c}let g="../GlobalStyles";if(r.textStyle){let c=T(r.textStyle);i+=`${s}  - TextStyle Ref: [${m(r.textStyle)}](${g}/Typography.md#${m(c)}) (See Typography Styles)
`}if(r.fills){let c=T(r.fills);i+=`${s}  - Fills Ref: [${m(r.fills)}](${g}/Colors.md#${m(c)}) (See Color Styles)
`}if(r.strokes){let c=T(r.strokes);i+=`${s}  - Strokes Ref: [${m(r.strokes)}](${g}/Colors.md#${m(c)}) (See Color Styles for Borders)
`}if(r.effects){let c=T(r.effects);i+=`${s}  - Effects Ref: [${m(r.effects)}](${g}/Effects.md#${m(c)}) (See Effect Styles)
`}if(r.layout){let c=T(r.layout);i+=`${s}  - Layout Style Ref: [${m(r.layout)}](${g}/LayoutAndSpacing.md#${m(c)}) (See Layout Styles)
`}else r.type==="FRAME"||r.type==="GROUP"||r.type==="RECTANGLE"||r.type;r.children&&r.children.length>0&&(i+=Z(r.children,n+1,t,o))}return i}function Ft(e,n){let t=`# Component Analysis Report

`;t+=`## Summary

`,t+=`- **Total Components**: ${e.summary.totalComponents}
`,t+=`- **Complexity Score**: ${e.summary.complexityScore}/100
`,t+=`- **Consistency Score**: ${e.summary.consistencyScore}/100
`,t+=`- **Implementation Effort**: ${e.summary.implementationEffort.toUpperCase()}

`,t+=`## Atomic Design Hierarchy

`,t+=`### Atoms (${e.atomicHierarchy.atoms.length})
`,e.atomicHierarchy.atoms.length>0?e.atomicHierarchy.atoms.forEach(o=>{t+=`- ${o}
`}):t+=`No atoms identified.
`,t+=`
`,t+=`### Molecules (${e.atomicHierarchy.molecules.length})
`,e.atomicHierarchy.molecules.length>0?e.atomicHierarchy.molecules.forEach(o=>{t+=`- ${o}
`}):t+=`No molecules identified.
`,t+=`
`,t+=`### Organisms (${e.atomicHierarchy.organisms.length})
`,e.atomicHierarchy.organisms.length>0?e.atomicHierarchy.organisms.forEach(o=>{t+=`- ${o}
`}):t+=`No organisms identified.
`,t+=`
`,t+=`## Implementation Readiness

`,t+=`### Ready to Implement (${e.implementationReadiness.readyToImplement.length})
`,e.implementationReadiness.readyToImplement.forEach(o=>{t+=`- **${o.name}**: ${o.description||"No description"}
`}),t+=`
`,t+=`### Needs Specification (${e.implementationReadiness.needsSpecification.length})
`,e.implementationReadiness.needsSpecification.forEach(o=>{t+=`- **${o.name}**: ${o.description||"Requires more detailed specification"}
`}),t+=`
`,t+=`### Has Issues (${e.implementationReadiness.hasIssues.length})
`,e.implementationReadiness.hasIssues.forEach(o=>{t+=`- **${o.name}**: ${o.description||"Has implementation issues"}
`}),t+=`
`,t+=`## Design Patterns

`,e.designPatterns.forEach(o=>{t+=`### ${o.name}
`,t+=`${o.description}

`,t+=`**Components**: ${o.components.join(", ")}

`,t+=`**Usage**: ${o.usage}

`,t+=`**Implementation**: ${o.implementation}

`}),t+=`## Key Recommendations

`,e.summary.keyRecommendations.forEach(o=>{t+=`- ${o}
`}),h.writeFileSync(S.join(n,"ComponentAnalysis.md"),t)}function It(e,n){let t=`# Design System Validation Report

`,o=e.passed?"\u2705 PASSED":"\u274C FAILED";t+=`## Overall Status: ${o}

`,t+=`## Summary

`,t+=`- **Total Checks**: ${e.summary.totalChecks}
`,t+=`- **Passed**: ${e.summary.passed}
`,t+=`- **Failed**: ${e.summary.failed}
`,t+=`- **Warnings**: ${e.summary.warnings}

`,e.errors&&e.errors.length>0&&(t+=`## Errors

`,e.errors.forEach(i=>{t+=`### ${i.component}
`,t+=`**Rule**: ${i.rule}

`,t+=`**Issue**: ${i.issue}

`,t+=`**Severity**: ${i.severity}

`})),e.warnings&&e.warnings.length>0&&(t+=`## Warnings

`,e.warnings.forEach(i=>{t+=`### ${i.component}
`,t+=`**Rule**: ${i.rule}

`,t+=`**Issue**: ${i.issue}

`})),h.writeFileSync(S.join(n,"ValidationReport.md"),t)}function At(e,n){let t=`# Accessibility Compliance Report

`,o=e.filter(r=>r.severity==="error"),i=e.filter(r=>r.severity==="warning"),s=o.length===0?"\u2705 COMPLIANT":"\u274C ISSUES FOUND";t+=`## Overall Status: ${s}

`,t+=`## Summary

`,t+=`- **Total Issues**: ${e.length}
`,t+=`- **Critical Issues**: ${o.length}
`,t+=`- **Warnings**: ${i.length}

`,o.length>0&&(t+=`## Critical Issues

`,o.forEach(r=>{t+=`### ${r.component}
`,t+=`**Type**: ${r.type}

`,t+=`**Issue**: ${r.issue}

`,t+=`**Suggestion**: ${r.suggestion}

`})),i.length>0&&(t+=`## Warnings

`,i.forEach(r=>{t+=`### ${r.component}
`,t+=`**Type**: ${r.type}

`,t+=`**Issue**: ${r.issue}

`,t+=`**Suggestion**: ${r.suggestion}

`})),e.length===0&&(t+=`## No Issues Found

`,t+=`Congratulations! Your design system meets accessibility compliance standards.

`),h.writeFileSync(S.join(n,"AccessibilityReport.md"),t)}function Nt(e,n,t){let o=`# Implementation Guide

`;o+=`This guide provides developers with practical information for implementing the design system components.

`,o+=`## Quick Start

`,o+=`### Priority Components

`,o+=`Start with these components for maximum impact:

`,e.implementationReadiness.readyToImplement.slice(0,5).forEach(i=>{o+=`#### ${i.name}
`,o+=`**Category**: ${i.category}

`,o+=`**Props**:
`,i.props.forEach(s=>{o+=`- \`${s.name}\` (${s.type}): ${s.description||"No description"}
`}),o+=`
`,i.codeHints.examples.length>0&&(o+=`**Example Usage**:
`,o+="```jsx\n",o+=i.codeHints.examples[0],o+="\n```\n\n")}),o+=`## Design Token Usage

`,o+=`### Colors
`,Object.keys(n.colors).slice(0,10).forEach(i=>{let s=n.colors[i],r=typeof s=="string"?s:s.value;o+=`- \`${i}\`: ${r}
`}),o+=`
`,o+=`### Typography
`,Object.keys(n.typography).slice(0,5).forEach(i=>{let s=n.typography[i];o+=`- \`${i}\`: ${s.value.fontSize}px, ${s.value.fontWeight}
`}),o+=`
`,o+=`## Component Relationships

`,o+=`Understanding how components work together:

`,e.designPatterns.forEach(i=>{o+=`### ${i.name} Pattern
`,o+=`${i.description}

`,o+=`**Implementation Notes**: ${i.implementation}

`}),o+=`## Best Practices

`,e.summary.keyRecommendations.forEach(i=>{o+=`- ${i}
`}),h.writeFileSync(S.join(t,"ImplementationGuide.md"),o)}import ke from"js-yaml";import R from"fs";import L from"path";import Te from"os";function xe(e){let n=[];if(e.colors){let t=Dt(e.colors);t.variables.length>0&&n.push(t)}if(e.typography){let t=Ot(e.typography);t.variables.length>0&&n.push(t)}if(e.spacing){let t=Pt(e.spacing);t.variables.length>0&&n.push(t)}return{collections:n,metadata:{totalVariables:n.reduce((t,o)=>t+o.variables.length,0),deductionMethod:"pattern-analysis",limitations:["Cannot detect mode/theme variations (light/dark)","Cannot identify variable references to other variables","Variable names are algorithmically generated, not original designer names","Cannot determine complete semantic intent","Single mode only (no theme switching capability)"]}}}function Dt(e){let n=[],t={};for(let[o,i]of Object.entries(e)){let s=typeof i=="string"?i:i.value;if(typeof s!="string")continue;let r=o.match(/^(.+)-(\d+)$/);if(r){let[,a,l]=r;t[a]||(t[a]=[]),t[a].push({name:`${a}-${l}`,type:"color",value:s,category:a,usage:ve(o,i)})}else n.push({name:o,type:"color",value:s,usage:ve(o,i)})}for(let[o,i]of Object.entries(t))n.push(...i);return{name:"Colors",variables:n,description:"Deduced color variables from design tokens"}}function Ot(e){let n=[];for(let[t,o]of Object.entries(e)){let i=o.value;!i||typeof i!="object"||(i.fontSize&&n.push({name:`${t}-size`,type:"number",value:i.fontSize,category:"typography",usage:["font-size"]}),i.lineHeight&&n.push({name:`${t}-line-height`,type:"number",value:i.lineHeight,category:"typography",usage:["line-height"]}),i.fontWeight&&n.push({name:`${t}-weight`,type:"number",value:i.fontWeight,category:"typography",usage:["font-weight"]}),i.letterSpacing&&n.push({name:`${t}-letter-spacing`,type:"number",value:i.letterSpacing,category:"typography",usage:["letter-spacing"]}))}return{name:"Typography",variables:n,description:"Deduced typography variables from design tokens"}}function Pt(e){let n=[];for(let[t,o]of Object.entries(e)){let i=typeof o=="string"?o:o.value;if(typeof i!="string")continue;let s=i.match(/^(\d+(?:\.\d+)?)px$/),r=s?parseFloat(s[1]):i;n.push({name:t,type:typeof r=="number"?"number":"string",value:r,category:"spacing",usage:["margin","padding","gap"]})}return{name:"Spacing",variables:n,description:"Deduced spacing variables from design tokens"}}function ve(e,n){let t=[];return e.includes("border")||e.includes("stroke")?t.push("border-color"):e.includes("background")||e.includes("bg")?t.push("background-color"):e.includes("text")||e.includes("foreground")?t.push("color"):t.push("color","background-color","border-color"),n.type==="borderColor"&&(t.length=0,t.push("border-color")),t}function we(e){let n={},t={};return e.collections.forEach((o,i)=>{let s=`deduced-collection-${i}`;n[s]={id:s,name:o.name,description:o.description,variableIds:o.variables.map((r,a)=>`deduced-var-${i}-${a}`),modes:[{modeId:"deduced-mode-default",name:"Default"}]},o.variables.forEach((r,a)=>{let l=`deduced-var-${i}-${a}`;t[l]={id:l,name:r.name,resolvedType:r.type.toUpperCase(),valuesByMode:{"deduced-mode-default":r.value},description:`Deduced from design tokens. Usage: ${r.usage?.join(", ")||"unknown"}`,scopes:["ALL_SCOPES"],codeSyntax:{}}})}),{status:200,error:!1,meta:{variableCollections:n,variables:t,deductionMetadata:e.metadata}}}import _ from"fs/promises";var Vt={name:"Figma MCP Server by Bao To",version:"0.6.41"};function Re(e,{isHTTP:n=!1}={}){let t=new jt(Vt),o=new M(e);return Mt(t,o),d.isHTTP=n,t}function Mt(e,n){e.tool("get_figma_data","When the nodeId cannot be obtained, obtain the layout information about the entire Figma file",{fileKey:y.string().describe("The key of the Figma file to fetch, often found in a provided URL like figma.com/(file|design)/<fileKey>/..."),nodeId:y.string().optional().describe("The ID of the node to fetch, often found as URL parameter node-id=<nodeId>, always use if provided"),depth:y.number().optional().describe("How many levels deep to traverse the node tree, only use if explicitly requested by the user")},async({fileKey:t,nodeId:o,depth:i})=>{try{d.log(`Fetching ${i?`${i} layers deep`:"all layers"} of ${o?`node ${o} from file`:"full file"} ${t}`);let s;o?s=await n.getNode(t,o,i):s=await n.getFile(t,i),d.log(`Successfully fetched file: ${s.name}`);let{nodes:r,globalVars:a,...l}=s,g={metadata:l,nodes:r,globalVars:a};d.log("Generating YAML result from file");let c=ke.dump(g);return d.log("Sending result to client"),{content:[{type:"text",text:c}]}}catch(s){let r=s instanceof Error?s.message:JSON.stringify(s);return d.error(`Error fetching file ${t}:`,r),{isError:!0,content:[{type:"text",text:`Error fetching file: ${r}`}]}}}),e.tool("download_figma_images","Download SVG and PNG images used in a Figma file based on the IDs of image or icon nodes",{fileKey:y.string().describe("The key of the Figma file containing the node"),nodes:y.object({nodeId:y.string().describe("The ID of the Figma image node to fetch, formatted as 1234:5678"),imageRef:y.string().optional().describe("If a node has an imageRef fill, you must include this variable. Leave blank when downloading Vector SVG images."),fileName:y.string().describe("The local name for saving the fetched file")}).array().describe("The nodes to fetch as images"),localPath:y.string().describe("The absolute path to the directory where images are stored in the project. If the directory does not exist, it will be created. The format of this path should respect the directory format of the operating system you are running on. Don't use any special character escaping in the path name either.")},async({fileKey:t,nodes:o,localPath:i})=>{try{let s=o.filter(({imageRef:p})=>!!p),r=n.getImageFills(t,s,i),a=o.filter(({imageRef:p})=>!p).map(({nodeId:p,fileName:f})=>({nodeId:p,fileName:f,fileType:f.endsWith(".svg")?"svg":"png"})),l=n.getImages(t,a,i),g=await Promise.all([r,l]).then(([p,f])=>[...p,...f]);return{content:[{type:"text",text:!g.find(p=>!p)?`Success, ${g.length} images downloaded: ${g.join(", ")}`:"Failed"}]}}catch(s){return d.error(`Error downloading images from file ${t}:`,s),{isError:!0,content:[{type:"text",text:`Error downloading images: ${s}`}]}}}),e.tool("get_figma_variables","Retrieves all variables and variable collections from a Figma file. Variables are different from design tokens - they are Figma's dynamic values system that can store colors, numbers, strings, and booleans with different modes/themes.",{fileKey:y.string().describe("The key of the Figma file to extract variables from, found in the Figma file URL."),scope:y.enum(["local","published"]).optional().default("local").describe("Whether to fetch local variables (all variables in the file) or published variables (only those published to team library). Defaults to 'local'."),outputFilePath:y.string().optional().describe("Optional full path (including filename) where the output JSON file should be saved. If not provided, variables data will be returned in the response.")},async({fileKey:t,scope:o="local",outputFilePath:i})=>{try{d.log(`Getting Figma variables for file: ${t} (scope: ${o})`);let s=await n.getVariables(t,o);if(d.log(`Successfully fetched variables from file: ${t}`),i){let r=L.dirname(i);return R.existsSync(r)||(R.mkdirSync(r,{recursive:!0}),d.log(`Created directory: ${r}`)),R.writeFileSync(i,JSON.stringify(s,null,2)),d.log(`Variables successfully saved to: ${i}`),{content:[{type:"text",text:`Variables successfully retrieved and saved to: ${i}`}]}}else return{content:[{type:"text",text:ke.dump(s)}]}}catch(s){let r=s instanceof Error?s.message:JSON.stringify(s);return d.error(`Error getting variables for file ${t}:`,r),{isError:!0,content:[{type:"text",text:`Error getting variables: ${r}`}]}}}),e.tool("generate_design_tokens","Extracts design tokens (colors, typography, spacing, effects) from a Figma file and saves them as a JSON file.",{fileKey:y.string().describe("The key of the Figma file to extract tokens from, found in the Figma file URL."),outputFilePath:y.string().optional().describe("Optional full path (including filename) where the output JSON file should be saved. If not provided, it will be saved in a temporary directory."),includeDeducedVariables:y.boolean().optional().default(!1).describe("Whether to include deduced variables analysis as a workaround for Enterprise-only Variables API. This analyzes design tokens to create variable-like structures but has limitations compared to real Figma Variables.")},async({fileKey:t,outputFilePath:o,includeDeducedVariables:i})=>{try{d.log(`Generating design tokens for file: ${t}`);let s=await n.getFile(t);d.log(`Successfully fetched file: ${s.name}`);let r=k(s);d.log("Design tokens generated.");let a={designTokens:r};if(i){d.log("Analyzing design tokens to deduce variable-like structures...");let f=xe(r);a.deducedVariables=f,a.variablesApiCompatible=we(f),d.log(`Deduced ${f.metadata.totalVariables} variables from design tokens.`)}let l,g=s.name?s.name.replace(/[\/\s<>:"\\|?*]+/g,"_"):"untitled_figma_design",c=i?`${g}_tokens_with_variables.json`:`${g}_tokens.json`;if(o){l=o;let f=L.dirname(l);R.existsSync(f)||(R.mkdirSync(f,{recursive:!0}),d.log(`Created directory: ${f}`))}else l=L.join(Te.tmpdir(),c),d.log(`outputFilePath not provided, using temporary path: ${l}`);R.writeFileSync(l,JSON.stringify(a,null,2));let p=`Design tokens successfully generated and saved to: ${l}`;if(i){let f=a.deducedVariables;p+=`

Deduced Variables Analysis included:`,p+=`
- Total variables: ${f.metadata.totalVariables}`,p+=`
- Collections: ${f.collections.map(u=>u.name).join(", ")}`,p+=`
- Limitations: This is a workaround analysis with limitations compared to real Figma Variables`,p+=`
  - ${f.metadata.limitations.join(`
  - `)}`}return d.log(p),{content:[{type:"text",text:p}]}}catch(s){let r=s instanceof Error?s.message:JSON.stringify(s);return d.error(`Error generating design tokens for file ${t}:`,r),{isError:!0,content:[{type:"text",text:`Error generating design tokens: ${r}`}]}}}),e.tool("generate_design_system_doc","Generates a comprehensive set of Markdown documents detailing the design system from a Figma file into a specified directory.",{fileKey:y.string().describe("The key of the Figma file to document, found in the Figma file URL."),outputDirectoryPath:y.string().optional().describe("Optional full path to the directory where the documentation files should be saved. If not provided, files and folders (e.g., _Overview.md, GlobalStyles/, Components/) will be generated in a new unique directory within the system's temporary folder. The full path to this temporary directory will be returned in the response. To save directly into a specific project directory, this path must be provided.")},async({fileKey:t,outputDirectoryPath:o})=>{try{d.log(`Generating structured design system documentation for file: ${t}`);let i=await n.getFile(t);d.log(`Successfully fetched file: ${i.name}`);let s,r=i.name?i.name.replace(/[/\\s<>:"\|?*]+/g,"_"):"untitled_figma_design";if(o)s=o,d.log(`Using provided outputDirectoryPath: ${s}`);else{let a=`${r}_design_system_docs_${Date.now()}`;s=L.join(Te.tmpdir(),a),d.log(`outputDirectoryPath not provided, defaulting to temporary directory: ${s}`)}return R.existsSync(s)||(R.mkdirSync(s,{recursive:!0}),d.log(`Created directory: ${s}`)),Ce(i,s),d.log(`Design system documentation successfully generated into directory: ${s}`),{content:[{type:"text",text:`Design system documentation successfully generated into directory: ${s}`}]}}catch(i){let s=i instanceof Error?i.message:JSON.stringify(i);return d.error(`Error generating design system documentation for file ${t}:`,s),{isError:!0,content:[{type:"text",text:`Error generating design system documentation: ${s}`}]}}}),e.tool("compare_design_tokens","Compare design tokens between two Figma files or token sets to identify changes, additions, and removals.",{fileKey1:y.string().describe("The key of the first Figma file for comparison."),fileKey2:y.string().describe("The key of the second Figma file for comparison."),outputFilePath:y.string().optional().describe("Optional path to save the comparison results as JSON.")},async t=>{let{fileKey1:o,fileKey2:i,outputFilePath:s}=t;try{let r=await n.getFile(o),a=k(r),l=await n.getFile(i),g=k(l),c=await Y(a,g,s);return{content:[{type:"text",text:`Token Comparison Results:
              
\u{1F4CA} **Summary:**
- Added: ${c.added.length} tokens
- Removed: ${c.removed.length} tokens  
- Modified: ${c.modified.length} tokens
- Unchanged: ${c.unchanged.length} tokens

${c.added.length>0?`
\u2795 **Added Tokens:**
${c.added.map(p=>`- ${p}`).join(`
`)}`:""}

${c.removed.length>0?`
\u2796 **Removed Tokens:**
${c.removed.map(p=>`- ${p}`).join(`
`)}`:""}

${c.modified.length>0?`
\u{1F504} **Modified Tokens:**
${c.modified.map(p=>`- ${p.name}: ${p.changes.join(", ")}`).join(`
`)}`:""}

${s?`
\u{1F4BE} **Results saved to:** ${s}`:""}`}]}}catch(r){return{content:[{type:"text",text:`\u274C Error comparing design tokens: ${r instanceof Error?r.message:"Unknown error"}`}]}}}),e.tool("validate_design_system","Validate design tokens against design system best practices and rules.",{fileKey:y.string().describe("The key of the Figma file to validate."),outputFilePath:y.string().optional().describe("Optional path to save the validation results as JSON.")},async t=>{let{fileKey:o,outputFilePath:i}=t;try{let s=await n.getFile(o),r=k(s),a=H(r);return i&&await _.writeFile(i,JSON.stringify(a,null,2),"utf-8"),{content:[{type:"text",text:`Design System Validation Results: ${a.passed?"\u2705 PASSED":"\u274C FAILED"}

\u{1F4CA} **Summary:**
- Total Checks: ${a.summary.totalChecks}
- Passed: ${a.summary.passed}
- Failed: ${a.summary.failed}  
- Warnings: ${a.summary.warnings}

${a.errors.length>0?`
\u{1F6AB} **Errors:**
${a.errors.map(g=>`- [${g.rule}] ${g.component}: ${g.issue}`).join(`
`)}`:""}

${a.warnings.length>0?`
\u26A0\uFE0F **Warnings:**
${a.warnings.map(g=>`- [${g.rule}] ${g.component}: ${g.issue}`).join(`
`)}`:""}

${i?`
\u{1F4BE} **Results saved to:** ${i}`:""}`}]}}catch(s){return{content:[{type:"text",text:`\u274C Error validating design system: ${s instanceof Error?s.message:"Unknown error"}`}]}}}),e.tool("check_accessibility","Check design tokens for accessibility compliance issues (contrast, text sizes, etc.).",{fileKey:y.string().describe("The key of the Figma file to check for accessibility."),outputFilePath:y.string().optional().describe("Optional path to save the accessibility report as JSON.")},async t=>{let{fileKey:o,outputFilePath:i}=t;try{let s=await n.getFile(o),r=k(s),a=G(r);i&&await _.writeFile(i,JSON.stringify(a,null,2),"utf-8");let l=a.filter(p=>p.severity==="error").length,g=a.filter(p=>p.severity==="warning").length;return{content:[{type:"text",text:`Accessibility Check Results: ${l===0?"\u2705 PASSED":"\u274C FAILED"}

\u{1F4CA} **Summary:**
- Total Issues: ${a.length}
- Errors: ${l}
- Warnings: ${g}

${a.length>0?`
\u{1F50D} **Issues Found:**
${a.map(p=>`${p.severity==="error"?"\u{1F6AB}":"\u26A0\uFE0F"} [${p.type}] ${p.component}: ${p.issue}
   \u{1F4A1} ${p.suggestion}`).join(`

`)}`:`
\u{1F389} **No accessibility issues found!**`}

${i?`
\u{1F4BE} **Report saved to:** ${i}`:""}`}]}}catch(s){return{content:[{type:"text",text:`\u274C Error checking accessibility: ${s instanceof Error?s.message:"Unknown error"}`}]}}}),e.tool("migrate_tokens","Convert design tokens to different formats (Tailwind, CSS Variables, Style Dictionary, Figma Tokens).",{fileKey:y.string().describe("The key of the Figma file containing the tokens to migrate."),targetFormat:y.enum(["tailwind","css-variables","style-dictionary","figma-tokens"]).describe("The target format to convert tokens to."),outputFilePath:y.string().describe("The path where the converted tokens should be saved.")},async t=>{let{fileKey:o,targetFormat:i,outputFilePath:s}=t;try{let r=await n.getFile(o),a=k(r),l=await be(a,i,s);return l.success?{content:[{type:"text",text:`\u2705 Token Migration Successful!

\u{1F4E6} **Details:**
- Format: ${l.format}
- Tokens Processed: ${l.summary.tokensProcessed}
- Output File: ${l.outputPath}

\u{1F389} Your design tokens have been successfully converted to ${i} format and saved to ${s}!`}]}:{content:[{type:"text",text:`\u274C Token Migration Failed!

\u{1F6AB} **Errors:**
${l.summary.errors.map(g=>`- ${g}`).join(`
`)}`}]}}catch(r){return{content:[{type:"text",text:`\u274C Error migrating tokens: ${r instanceof Error?r.message:"Unknown error"}`}]}}}),e.tool("check_design_code_sync","Compare Figma design tokens with code tokens to identify sync issues between design and implementation.",{fileKey:y.string().describe("The key of the Figma file to compare."),codeTokensPath:y.string().describe("Path to the code tokens file (JSON, JS, or TS format)."),outputFilePath:y.string().optional().describe("Optional path to save the sync comparison results.")},async t=>{let{fileKey:o,codeTokensPath:i,outputFilePath:s}=t;try{let r=await n.getFile(o),a=k(r),l=await $e(a,i);s&&await _.writeFile(s,JSON.stringify(l,null,2),"utf-8");let g=l.added.length+l.removed.length+l.modified.length;return{content:[{type:"text",text:`Design-Code Sync Check: ${g===0?"\u2705 IN SYNC":"\u{1F504} OUT OF SYNC"}

\u{1F4CA} **Summary:**
- In Sync: ${l.unchanged.length} tokens
- Need Updates: ${g} tokens

${l.added.length>0?`
\u2795 **Missing in Code:**
${l.added.map(p=>`- ${p}`).join(`
`)}`:""}

${l.removed.length>0?`
\u2796 **Extra in Code:**
${l.removed.map(p=>`- ${p}`).join(`
`)}`:""}

${l.modified.length>0?`
\u{1F504} **Value Differences:**
${l.modified.map(p=>`- ${p.name}: ${p.changes.join(", ")}`).join(`
`)}`:""}

${g===0?`
\u{1F389} **Perfect sync!** Your design and code tokens are aligned.`:`
\u{1F4A1} **Action needed:** Update your code tokens to match the design.`}

${s?`
\u{1F4BE} **Results saved to:** ${s}`:""}`}]}}catch(r){return{content:[{type:"text",text:`\u274C Error checking design-code sync: ${r instanceof Error?r.message:"Unknown error"}`}]}}}),e.tool("analyze_figma_components","Analyzes Figma components to understand structure, variants, and relationships for intelligent AI-driven code generation. This tool helps AI agents understand component semantics, props, variants, and implementation patterns.",{fileKey:y.string().describe("The key of the Figma file to analyze for components."),outputFilePath:y.string().optional().describe("Optional path to save the component analysis results as JSON.")},async t=>{let{fileKey:o,outputFilePath:i}=t;try{let s=await n.getFile(o),r=B(s);i&&await _.writeFile(i,JSON.stringify(r,null,2),"utf-8");let{summary:a,atomicHierarchy:l,implementationReadiness:g,designPatterns:c}=r;return{content:[{type:"text",text:`Component Analysis Results for "${s.name}":

\u{1F4CA} **Summary:**
- Total Components: ${a.totalComponents}
- Atoms: ${a.byCategory.atom} | Molecules: ${a.byCategory.molecule} | Organisms: ${a.byCategory.organism}
- Complexity Score: ${a.complexityScore}/100
- Consistency Score: ${a.consistencyScore}/100
- Implementation Effort: ${a.implementationEffort.toUpperCase()}

\u{1F9F1} **Atomic Design Hierarchy:**
- \u269B\uFE0F  Atoms (${l.atoms.length}): ${l.atoms.join(", ")||"None"}
- \u{1F9EC} Molecules (${l.molecules.length}): ${l.molecules.join(", ")||"None"}
- \u{1F9A0} Organisms (${l.organisms.length}): ${l.organisms.join(", ")||"None"}
- \u{1F4C4} Templates (${l.templates.length}): ${l.templates.join(", ")||"None"}

\u{1F680} **Implementation Readiness:**
- \u2705 Ready to Implement (${g.readyToImplement.length}): ${g.readyToImplement.map(p=>p.name).join(", ")||"None"}
- \u26A0\uFE0F  Need Specification (${g.needsSpecification.length}): ${g.needsSpecification.map(p=>p.name).join(", ")||"None"}
- \u{1F6AB} Have Issues (${g.hasIssues.length}): ${g.hasIssues.map(p=>p.name).join(", ")||"None"}

\u{1F3A8} **Design Patterns Found (${c.length}):**
${c.map(p=>`- **${p.name}**: ${p.description}`).join(`
`)||"No patterns detected"}

\u{1F4A1} **Key Recommendations:**
${a.keyRecommendations.map(p=>`- ${p}`).join(`
`)}

\u{1F4CB} **For AI Code Generation:**
Each component now includes:
- Inferred props and variants
- HTML element suggestions
- React patterns and state management hints
- Accessibility requirements
- Code examples and usage patterns

${i?`
\u{1F4BE} **Full analysis saved to:** ${i}`:""}`}]}}catch(s){return{content:[{type:"text",text:`\u274C Error analyzing components: ${s instanceof Error?s.message:"Unknown error"}`}]}}})}Ht({path:Gt(process.cwd(),".env")});async function zt(){let e=process.env.NODE_ENV==="cli"||process.argv.includes("--stdio"),n=Q(e),t=Re(n.figmaApiKey,{isHTTP:!e});if(e){let o=new Bt;await t.connect(o)}else console.log(`Initializing Figma MCP Server in HTTP mode on port ${n.port}...`),await ne(n.port,t)}process.argv[1]&&zt().catch(e=>{console.error("Failed to start server:",e),process.exit(1)});export{Q as a,Re as b,zt as c};
